<system label="roaming_selection">

    <VARS>

        <VAR label="pdu_session_establishment_requested">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="process_initiated">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="sm_context_request">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="sm_context_request_success">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="sm_context_response">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="sm_context_response_success">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="n4_session_request">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="n4_session_request_success">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="n4_session_response">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="n4_session_response_success">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="nsmf_pdu_session_request">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="nsmf_pdu_session_response_success">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="nsmf_pdu_session_response">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="nsmf_message_transfer">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="n2_pdu_session_request">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="n2_pdu_session_request_success">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="n2_pdu_session_ACK">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="n2_pdu_session_ACKed">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

    </VARS>

    <FSMs>
        <FSM label="visited_plmn">

            <states>
                <state>no_session</state>
                <state>session_establishment_requested</state>
                <state>sm_context_requested</state>
                <state>sm_context_complete</state>
                <state>n4_session_requested</state>
                <state>n4_session_complete</state>
                <state>nsmf_pdu_requested</state>
                <state>nsmf_pdu_complete</state>
                <state>n2_pdu_requested</state>
                <state>session_establishment_successful</state>
            </states>

            <init_state>no_session</init_state>

            
            <transitions>
                <transition label="T1_T1">
                    <start>no_session</start>
                    <end>session_establishment_requested</end>

                    <condition>
                        pdu_session_establishment_requested
                    </condition>

                    <actions>
                        <action label="establish_request">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="process_initiated = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T2_T2">
                    <start>session_establishment_requested</start>
                    <end>sm_context_requested</end>

                    <condition>
                        process_initiated &amp; sm_context_request_success
                    </condition>

                    <actions>
                        <action label="send_sm_context_request">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="sm_context_request = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T3_T3">
                    <start>sm_context_requested</start>
                    <end>sm_context_complete</end>

                    <condition>
                        process_initiated &amp; sm_context_request &amp; sm_context_response_success
                    </condition>

                    <actions>
                        <action label="rcv_sm_context_response">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="sm_context_response = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="failure_T4">
                    <start>sm_context_requested</start>
                    <end>sm_context_requested</end>

                    <condition>
                        process_initiated &amp; sm_context_request &amp; !sm_context_response_success
                    </condition>

                    <actions>
                        <action label="null_action">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T4_T5">
                    <start>sm_context_complete</start>
                    <end>n4_session_requested</end>

                    <condition>
                        process_initiated &amp; sm_context_request &amp; sm_context_response &amp; n4_session_request_success
                    </condition>

                    <actions>
                        <action label="send_n4_request">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="n4_session_request = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T5_T6">
                    <start>n4_session_requested</start>
                    <end>n4_session_complete</end>

                    <condition>
                        process_initiated &amp; sm_context_request &amp; sm_context_response &amp; n4_session_request &amp; n4_session_response_success
                    </condition>

                    <actions>
                        <action label="rcv_n4_response">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="n4_session_response = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T6_T7">
                    <start>n4_session_complete</start>
                    <end>nsmf_pdu_requested</end>

                    <condition>
                        process_initiated &amp; sm_context_request &amp; sm_context_response &amp; n4_session_request &amp; n4_session_response
                    </condition>

                    <actions>
                        <action label="request_nsm_pdu">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="nsmf_pdu_session_request = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T7_T8">
                    <start>nsmf_pdu_requested</start>
                    <end>nsmf_pdu_complete</end>

                    <condition>
                        process_initiated &amp; sm_context_request &amp; sm_context_response &amp; n4_session_request &amp; n4_session_response &amp; nsmf_pdu_session_request &amp; nsmf_pdu_session_response_success
                    </condition>

                    <actions>
                        <action label="rcv_nsm_pdu_response">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="nsmf_pdu_session_response = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T8_T9">
                    <start>nsmf_pdu_complete</start>
                    <end>n2_pdu_requested</end>

                    <condition>
                        process_initiated &amp; sm_context_request &amp; sm_context_response &amp; n4_session_request &amp; n4_session_response &amp; nsmf_pdu_session_request &amp; nsmf_pdu_session_response &amp; nsmf_message_transfer &amp; n2_pdu_session_request_success
                    </condition>

                    <actions>
                        <action label="request_n2_pdu">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="n2_pdu_session_request = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T9_T10">
                    <start>n2_pdu_requested</start>
                    <end>session_establishment_successful</end>

                    <condition>
                        process_initiated &amp; sm_context_request &amp; sm_context_response &amp; n4_session_request &amp; n4_session_response &amp; nsmf_pdu_session_request &amp; nsmf_pdu_session_response &amp; nsmf_message_transfer &amp; n2_pdu_session_request &amp; n2_pdu_session_ACKed
                    </condition>

                    <actions>
                        <action label="n2_request_acked">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="n2_pdu_session_ACK = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

            </transitions>

        </FSM>
    </FSMs>

</system>