<system label="roaming_selection">

    <VARS>

        <VAR label="pdu_session_establishment_requested">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="process_initiated">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="sm_context_request">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="sm_context_request_success">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="sm_context_response">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="sm_context_response_success">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="n4_session_request">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="n4_session_request_success">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="n4_session_response">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="n4_session_response_success">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="nsmf_pdu_session_request">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="nsmf_pdu_session_response_success">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="n2_sm_info">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>        

        <VAR label="nsmf_pdu_session_response">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="nsmf_message_transfer">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="n2_pdu_session_request">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="namf_success">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>        

        <VAR label="n2_pdu_session_request_success">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="n2_pdu_session_ACK">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="n2_pdu_session_ACKed">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

        <VAR label="data_sent_up">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="data_done_processing">
            <datatype>boolean</datatype>
            <controltype>state</controltype>
            <possiblevalues>TRUE,FALSE</possiblevalues>
            <initialvalue>FALSE</initialvalue>
        </VAR>

        <VAR label="user_info_failure">
            <datatype>boolean</datatype>
            <controltype> environment </controltype>
            <fsm>visited_plmn</fsm>
        </VAR>

    </VARS>

    <FSMs>
        <FSM label="visited_plmn">

            <states>
                <state>no_session</state>
                <state>session_establishment_requested</state>
                <state>sm_context_requested</state>
                <state>sm_context_complete</state>
                <state>n4_session_requested</state>
                <state>n4_session_complete</state>
                <state>nsmf_pdu_requested</state>
                <state>nsmf_pdu_complete</state>
                <state>namf_message_transfer</state>
                <state>n2_pdu_requested</state>
                <state>session_establishment_successful</state>
                <state>data_sent_upstream</state>
                <state>data_processed_and_charged</state>
                <state>data_received</state>
            </states>

            <init_state>no_session</init_state>

            
            <transitions>
                <transition label="T1_T1">
                    <start>no_session</start>
                    <end>session_establishment_requested</end>

                    <condition>
                        pdu_session_establishment_requested
                    </condition>

                    <actions>
                        <action label="establish_request">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="process_initiated = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T2_T2">
                    <start>session_establishment_requested</start>
                    <end>sm_context_requested</end>

                    <condition>
                        process_initiated &amp; sm_context_request_success
                    </condition>

                    <actions>
                        <action label="send_sm_context_request">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="sm_context_request = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T3_T3">
                    <start>sm_context_requested</start>
                    <end>sm_context_complete</end>

                    <condition>
                        sm_context_request &amp; sm_context_response_success
                    </condition>

                    <actions>
                        <action label="rcv_sm_context_response">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="sm_context_response = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="failure_T4">
                    <start>no_session</start>
                    <end>no_session</end>

                    <condition>
                        !process_initiated
                    </condition>

                    <actions>
                        <action label="null_action">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T4_T5">
                    <start>sm_context_complete</start>
                    <end>n4_session_requested</end>

                    <condition>
                        sm_context_response &amp; n4_session_request_success
                    </condition>

                    <actions>
                        <action label="send_n4_request">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="n4_session_request = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T5_T6">
                    <start>n4_session_requested</start>
                    <end>n4_session_complete</end>

                    <condition>
                        n4_session_request &amp; n4_session_response_success
                    </condition>

                    <actions>
                        <action label="rcv_n4_response">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="n4_session_response = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T6_T7">
                    <start>n4_session_complete</start>
                    <end>nsmf_pdu_requested</end>

                    <condition>
                        n4_session_response
                    </condition>

                    <actions>
                        <action label="request_nsm_pdu">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="nsmf_pdu_session_request = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T7_T8">
                    <start>nsmf_pdu_requested</start>
                    <end>nsmf_pdu_complete</end>

                    <condition>
                        nsmf_pdu_session_request &amp; nsmf_pdu_session_response_success
                    </condition>

                    <actions>
                        <action label="rcv_nsm_pdu_response">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="nsmf_pdu_session_response = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T7_T9">
                    <start>nsmf_pdu_complete</start>
                    <end>namf_message_transfer</end>

                    <condition>
                        nsmf_pdu_session_request &amp; nsmf_pdu_session_response_success
                    </condition>

                    <actions>
                        <action label="rcv_nsm_pdu_response">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="nsmf_pdu_session_response = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="success_T10">
                    <start>namf_message_transfer</start>
                    <end>n2_pdu_requested</end>

                    <condition>
                        nsmf_pdu_session_response &amp; nsmf_message_transfer &amp; n2_pdu_session_request_success &amp; namf_success &amp; n2_sm_info
                    </condition>

                    <actions>
                        <action label="request_n2_pdu">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="n2_pdu_session_request = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="success_T11">
                    <start>namf_message_transfer</start>
                    <end>namf_message_transfer</end>

                    <condition>
                        !n2_sm_info
                    </condition>

                    <actions>
                        <action label="no_n2_sm_info">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="failed_T12">
                    <start>namf_message_transfer</start>
                    <end>no_session</end>

                    <condition>
                        nsmf_pdu_session_response &amp; nsmf_message_transfer &amp; n2_pdu_session_request_success &amp; !namf_success
                    </condition>

                    <actions>
                        <action label="request_n2_pdu">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="n2_pdu_session_request = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="T9_T13">
                    <start>n2_pdu_requested</start>
                    <end>session_establishment_successful</end>

                    <condition>
                        n2_pdu_session_request &amp; n2_pdu_session_ACKed
                    </condition>

                    <actions>
                        <action label="n2_request_acked">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="n2_pdu_session_ACK = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="data_T14">
                    <start>session_establishment_successful</start>
                    <end>data_sent_upstream</end>

                    <condition>
                        n2_pdu_session_ACK
                    </condition>

                    <actions>
                        <action label="data_sent">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="data_sent_up = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="data_T15">
                    <start>data_sent_upstream</start>
                    <end>data_processed_and_charged</end>

                    <condition>
                        data_sent_up
                    </condition>

                    <actions>
                        <action label="data_processing">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                        <action label="data_done_processing = TRUE">
                            <channel label="internal">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="user_T16">
                    <start>data_processed_and_charged</start>
                    <end>data_received</end>

                    <condition>
                        data_done_processing &amp; !user_info_failure
                    </condition>

                    <actions>
                        <action label="data_process_good">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

                <transition label="late_T17">
                    <start>data_processed_and_charged</start>
                    <end>no_session</end>

                    <condition>
                        user_info_failure
                    </condition>

                    <actions>
                        <action label="data_processing_fail">
                            <channel label="PLMN">
                            <start> visited_plmn </start>
                            <end> visited_plmn </end>
                            </channel>
                        </action>
                    </actions>
                </transition>

            </transitions>

        </FSM>
    </FSMs>

</system>